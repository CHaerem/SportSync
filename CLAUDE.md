# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

SportSync is a static website that displays a personalized sports dashboard using live data from various sports APIs. It focuses on upcoming events for football, golf, tennis, Formula 1, chess, esports, and Olympics, with Norway-centric time formatting and preferences. The site is automatically updated via GitHub Actions and hosted on GitHub Pages. It features an AI-powered editorial content system that generates daily briefs, featured sections, and "on the radar" content using Claude API.

## Architecture

This is a hybrid static/dynamic application:
- **Static Frontend**: Pure HTML/CSS/JS hosted on GitHub Pages
- **Automated Data Fetching**: GitHub Actions fetch fresh API data every 2 hours
- **AI Featured Content**: Claude API generates editorial briefs and featured sections each build
- **Curated Event Configs**: `scripts/config/*.json` files auto-discovered by build pipeline
- **Cached Data Strategy**: Pre-fetched JSON files with live API fallbacks
- **No Backend**: Serverless architecture using only GitHub infrastructure

### Key Components

- **docs/index.html** - Main dashboard with ultra-minimal embedded CSS
- **docs/js/dashboard.js** - Dashboard controller (temporal bands, expand/collapse, filters)
- **docs/js/dashboard-helpers.js** - Pure utility functions (grouping, brief generation, countdowns)
- **docs/js/asset-maps.js** - Team logo and golfer headshot URL mappings
- **docs/js/sport-config.js** - Sport metadata (emoji, color, aliases)
- **docs/js/sports-api.js** - API integration layer with cached data priority
- **docs/js/preferences-manager.js** - Favorites storage (localStorage)
- **docs/data/** - Pre-fetched JSON data files (auto-generated by GitHub Actions)
- **.github/workflows/update-sports-data.yml** - Automated data fetching workflow

### Data Flow

1. **GitHub Actions** run every 2 hours to fetch fresh sports data
2. **API calls** to TheSportsDB, ESPN, and other sources
3. **JSON files** are generated and committed to `docs/data/`
4. **`build-events.js`** auto-discovers curated configs from `scripts/config/*.json` and merges them into `events.json`
5. **`generate-featured.js`** calls Claude API with events + curated configs → generates `featured.json` (brief, sections, radar)
6. **Client-side JavaScript** loads `events.json` + `featured.json`, renders editorial dashboard

## Development Commands

- `npm run dev` - Start local development server (Python HTTP server on port 8000)
- `npm run build` - Fetch data, build events, build calendar
- `npm run build:events` - Aggregate sport data + curated configs into events.json
- `npm run generate:featured` - Generate featured.json with Claude API (needs ANTHROPIC_API_KEY)
- `npm test` - Run all tests (vitest)
- `npm run deploy` - Automatic deployment via GitHub Pages

## GitHub Actions Workflow

The **update-sports-data.yml** workflow:
- **Trigger**: Every 2 hours + manual dispatch
- **Fetches**: Football, Golf, Tennis, F1 data from free APIs
- **Generates**: Chess and Esports curated data
- **Builds**: events.json (with auto-discovered curated configs from `scripts/config/`)
- **Generates**: featured.json via Claude API (ANTHROPIC_API_KEY secret)
- **Commits**: Updated JSON files to repository
- **Deploys**: Automatically via GitHub Pages

### Workflow Features
- Error handling with fallback data
- Dependency-free Node.js execution
- Commit summaries with event counts
- Timezone-aware timestamps

## API Integration Strategy

**Priority order for each sport:**
1. **Pre-fetched data** from `docs/data/*.json` (updated by GitHub Actions)
2. **Live API calls** as fallback (TheSportsDB, ESPN)
3. **Mock data** as final fallback for development/errors

**APIs Used:**
- **TheSportsDB** - Football (Premier League) and Tennis events
- **ESPN Public API** - Golf (PGA Tour) and Formula 1 events
- **Curated Data** - Chess tournaments and Esports competitions

## File Structure

```
docs/
├── index.html              # Main dashboard (HTML + embedded CSS, editorial brief layout)
├── sw.js                   # Service worker for caching
├── js/
│   ├── dashboard.js        # Dashboard controller (brief, sections, bands, radar)
│   ├── dashboard-helpers.js # Pure utilities (grouping, brief, countdowns)
│   ├── asset-maps.js       # Team logos + golfer headshot URLs
│   ├── sport-config.js     # Sport metadata (7 sports incl. Olympics)
│   ├── sports-api.js       # API integration with cached data priority
│   └── preferences-manager.js # Favorites storage (localStorage)
└── data/                   # Pre-fetched API data (auto-generated)
    ├── events.json         # Unified events feed (includes curated configs)
    ├── featured.json       # AI-generated editorial content (brief, sections, radar)
    ├── football.json       # Football events + metadata
    ├── golf.json           # Golf tournaments + metadata
    ├── tennis.json         # Tennis matches + metadata
    ├── f1.json             # Formula 1 races + metadata
    ├── chess.json          # Chess tournaments + metadata
    ├── esports.json        # Esports competitions + metadata
    └── meta.json           # Update timestamps

scripts/
├── generate-featured.js    # Claude API → featured.json (brief, sections, radar)
├── build-events.js         # Aggregates sport JSONs + curated configs → events.json
├── config/                 # Auto-discovered curated event configs
│   └── olympics-2026.json  # Example: Winter Olympics 2026 schedule
└── lib/
    ├── llm-client.js       # LLM abstraction (Anthropic + OpenAI)
    └── helpers.js           # Shared utilities

.github/workflows/
└── update-sports-data.yml  # Automated data fetching + AI content workflow
```

## Development Notes

- **No build process** - pure static files with embedded CSS
- **Modern JavaScript** - ES6+ features, async/await patterns
- **Norwegian focus** - Europe/Oslo timezone, Norwegian teams prioritized
- **Error resilience** - Multiple fallback layers for robust operation
- **GitHub Pages** - Automatic deployment on push to main branch
- **Ultra-minimal design** - 540px reading column, no cards/badges/shadows
- **Temporal bands** - Events grouped into Today/Tomorrow/This Week/Later
- **Tournament grouping** - 3+ events from same tournament get a header
- **Click-to-expand** - Event rows expand to show venue, logos, streaming, favorites

## Extending the Dashboard

To add a new sport:
1. Add API fetching logic to the GitHub Actions workflow
2. Add sport config to `docs/js/sport-config.js`
3. Add filter dot to `docs/index.html`
4. Events will auto-display via temporal band grouping in `dashboard.js`

To add a curated major event (Olympics, World Cup, etc.):
1. Create a JSON config in `scripts/config/{event}-{year}.json` (see `olympics-2026.json` for format)
2. Events auto-merge into `events.json` during build — no registration needed
3. `generate-featured.js` auto-detects the config and feeds it to Claude for featured content
4. The autopilot should create these configs autonomously (see `AUTOPILOT_ROADMAP.md`)

## Automation Rules

These rules govern automated Claude Code operations via GitHub Actions (`claude-code-action`).

### Protected Paths (never modify automatically)
- `.github/workflows/**`
- `package.json`, `package-lock.json`
- `.env*`
- `.git/**`
- `node_modules/**`

### Allowed Paths
- `scripts/**`
- `tests/**`
- `docs/js/**`
- `docs/index.html`
- `docs/*.md`
- `docs/sw.js`
- `docs/css/**`
- `AUTOPILOT_ROADMAP.md`
- `docs/data/autopilot-log.json`

### Change Limits
- Maximum **8 files** per automated PR
- Maximum **300 lines changed** per automated PR
- One bounded fix per maintenance run

### Risk Classification
- **LOW** — typo fixes, comment updates, test additions → auto-PR
- **MEDIUM** — logic changes, dependency updates, config changes → PR + request review
- **HIGH** — workflow changes, auth changes, data schema changes → skip (create issue only)

### Testing
- Always run `npm test` before committing
- If tests fail, revert changes and report in the PR or issue

### Branch Naming
- All automated branches must use the prefix `claude/`
- Autopilot branches use the prefix `claude/improve-`

### Autopilot

The autopilot workflow (`claude-autopilot.yml`) proactively improves the codebase using a roadmap-driven approach:

- **Roadmap**: `AUTOPILOT_ROADMAP.md` is the prioritized task queue
- **Cadence**: Runs nightly at 03:00 UTC
- **PR label**: `autopilot`
- **Multi-task loop**: The autopilot works through PENDING tasks continuously until it runs out of turns, tasks, or hits an error
- **Auto-merge**: Each task is branched, PR'd, and merged immediately after tests pass
- **Self-curating**: After completing tasks, the autopilot scouts the codebase for new improvement opportunities and appends them to the roadmap
- **Safe stops**: If tests fail or a merge fails, the loop stops — no broken code gets pushed
- **Human control**: Reorder tasks in the roadmap to change priority. Mark tasks `[BLOCKED]` to skip them.