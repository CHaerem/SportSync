# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

SportSync is a static website that displays a personalized sports dashboard using live data from various sports APIs. It focuses on upcoming events for football, golf, tennis, Formula 1, chess, esports, and Olympics, with Norway-centric time formatting and preferences. The site is automatically updated via GitHub Actions and hosted on GitHub Pages. It features an AI-powered editorial content system that generates daily briefs, featured sections, and "on the radar" content using Claude API, plus client-side live score polling from ESPN.

## Architecture

This is a hybrid static/dynamic application:
- **Static Frontend**: Pure HTML/CSS/JS hosted on GitHub Pages
- **Automated Data Fetching**: GitHub Actions fetch fresh API data every 2 hours
- **AI Enrichment**: LLM adds importance scores, summaries, and tags to each event
- **AI Featured Content**: Claude CLI generates editorial briefs and featured sections each build
- **Standings & RSS**: ESPN standings and RSS news digests feed into the editorial pipeline
- **Live Score Polling**: Client-side ESPN polling every 60s for football scores and golf leaderboards
- **Curated Event Configs**: `scripts/config/*.json` files auto-discovered by build pipeline
- **Autonomous Discovery**: Config maintenance (prune, archive) + LLM-powered event/athlete discovery via Claude CLI + WebSearch
- **No Backend**: Serverless architecture using only GitHub infrastructure

### Key Components

- **docs/index.html** - Main dashboard with ultra-minimal embedded CSS (480px max-width)
- **docs/js/dashboard.js** - Dashboard controller (~860 lines): brief, sections, events, standings, live polling
- **docs/js/asset-maps.js** - Team logo and golfer headshot URL mappings
- **docs/js/sport-config.js** - Sport metadata (emoji, color, aliases for 7 sports)
- **docs/js/preferences-manager.js** - Favorites storage (localStorage)
- **docs/data/** - Pre-fetched JSON data files (auto-generated by GitHub Actions)
- **.github/workflows/update-sports-data.yml** - Automated data pipeline workflow

### Data Flow

1. **GitHub Actions** run every 2 hours to fetch fresh sports data
2. **API calls** to ESPN, PandaScore, and fotball.no
3. **JSON files** are generated and committed to `docs/data/`
4. **`fetch-standings.js`** fetches PL table, golf leaderboards, F1 driver standings from ESPN
5. **`fetch-rss.js`** fetches 11 RSS feeds (NRK, TV2, BBC, ESPN, Autosport, ChessBase, HLTV)
6. **`sync-configs.js`** prunes expired events, archives old configs, flags empty auto-generated configs as `needsResearch`
7. **`discover-events.js`** uses Claude CLI + WebSearch to research and populate flagged configs with real schedules and Norwegian athletes
8. **`build-events.js`** auto-discovers curated configs from `scripts/config/*.json` and merges them into `events.json`
9. **`enrich-events.js`** uses LLM to add importance (1-5), summaries, tags, and Norwegian relevance to each event
10. **`generate-featured.js`** calls Claude CLI with events + standings + RSS + curated configs → generates `featured.json` (brief, sections, radar)
11. **`pipeline-health.js`** checks sport coverage, data freshness, RSS/standings health → generates `health-report.json`
12. **`check-quality-regression.js`** compares AI quality scores against previous commit → alerts on regressions
13. **`detect-coverage-gaps.js`** cross-references RSS headlines against events → generates `coverage-gaps.json`
14. **Client-side** loads `events.json` + `featured.json` + `standings.json`, renders editorial dashboard
15. **Live polling** fetches ESPN football scores and golf leaderboard every 60s, updates DOM inline

## Development Commands

- `npm run dev` - Start local development server (Python HTTP server on port 8000)
- `npm run build` - Fetch data, build events, build calendar
- `npm run build:events` - Aggregate sport data + curated configs into events.json
- `npm run enrich` - AI enrichment of events (needs OPENAI_API_KEY or ANTHROPIC_API_KEY)
- `npm run generate:featured` - Generate featured.json with Claude CLI (needs CLAUDE_CODE_OAUTH_TOKEN, or ANTHROPIC_API_KEY, or OPENAI_API_KEY)
- `npm test` - Run all tests (vitest, 279 tests across 18 files)
- `npm run validate:data` - Check data integrity
- `npm run build:calendar` - Create .ics calendar export

## GitHub Actions Workflow

The **update-sports-data.yml** workflow:
- **Trigger**: Every 2 hours + manual dispatch
- **Fetches**: Football, Golf, Tennis, F1, Chess, Esports data from APIs
- **Fetches**: Standings (ESPN PL/golf/F1) and RSS news digest (11 feeds)
- **Builds**: events.json (with auto-discovered curated configs from `scripts/config/`)
- **Enriches**: AI adds importance, summaries, tags to events (OpenAI)
- **Generates**: featured.json via Claude CLI (CLAUDE_CODE_OAUTH_TOKEN)
- **Validates**: Data integrity checks
- **Monitors**: Pipeline health report, quality regression gate, coverage gap detection
- **Commits**: Updated JSON files to repository
- **Deploys**: Automatically via GitHub Pages

### Auth Priority for Featured Generation
1. `CLAUDE_CODE_OAUTH_TOKEN` — Claude CLI (Max subscription)
2. `ANTHROPIC_API_KEY` — direct Anthropic API
3. `OPENAI_API_KEY` — OpenAI fallback
4. Template-based fallback (no AI)

## API Integration Strategy

**APIs Used:**
- **ESPN Public API** - Football (Premier League, La Liga), Tennis, Golf (PGA/DP World), F1, Standings
- **PGA Tour** - Golf field verification and tee times (scraped from pgatour.com)
- **fotball.no** - Norwegian OBOS-ligaen matches (Lyn Oslo)
- **PandaScore API** - Esports CS2 competitions (needs PANDASCORE_API_KEY)
- **Curated Data** - Chess tournaments, Olympics schedules

**Client-side live polling (no API key needed):**
- ESPN Soccer Scoreboard — live football scores
- ESPN Golf Scoreboard — live PGA leaderboard

## File Structure

```
docs/
├── index.html              # Dashboard (HTML + embedded CSS, 480px max-width)
├── sw.js                   # Service worker for caching
├── js/
│   ├── dashboard.js        # Dashboard controller (brief, sections, standings, live polling)
│   ├── asset-maps.js       # Team logos + golfer headshot URLs
│   ├── sport-config.js     # Sport metadata (7 sports incl. Olympics)
│   └── preferences-manager.js # Favorites storage (localStorage)
└── data/                   # Pre-fetched API data (auto-generated)
    ├── events.json         # Unified events feed (includes curated configs + enrichment)
    ├── featured.json       # AI-generated editorial content (brief, sections, radar)
    ├── standings.json      # ESPN standings (PL table, golf leaderboards, F1 drivers)
    ├── rss-digest.json     # RSS news digest (11 feeds, Norwegian-filtered)
    ├── ai-quality.json     # AI quality-gate metrics (enrichment + featured)
    ├── health-report.json  # Pipeline health report (coverage, freshness, anomalies)
    ├── coverage-gaps.json  # RSS vs events coverage gap detection
    ├── discovery-log.json  # Event discovery actions log
    ├── config-sync-log.json # Config sync/maintenance log
    ├── events.ics          # Calendar export
    ├── football.json       # Per-sport source files
    ├── golf.json / tennis.json / f1.json / chess.json / esports.json
    └── meta.json           # Update timestamps

scripts/
├── fetch/                  # Modular API fetchers (one per sport)
├── config/                 # Auto-discovered curated event configs
│   ├── archive/            # Expired configs (auto-archived by sync-configs.js)
│   ├── olympics-2026.json  # Winter Olympics 2026 schedule
│   ├── user-context.json   # User preferences + dynamicAthletes config
│   ├── chess-tournaments.json
│   └── norwegian-chess-players.json
├── lib/
│   ├── llm-client.js       # LLM abstraction (Anthropic + OpenAI)
│   ├── helpers.js          # Shared utilities
│   ├── enrichment-prompts.js # Prompts for AI event enrichment
│   ├── event-normalizer.js # Event validation and normalization
│   ├── response-validator.js # API response validation (ESPN, PandaScore)
│   ├── ai-quality-gates.js # AI enrichment quality gates and fallbacks
│   ├── base-fetcher.js     # Base class for sport fetchers
│   ├── api-client.js       # HTTP client wrapper
│   ├── norwegian-streaming.js # Norwegian streaming info
│   └── filters.js          # Event filtering utilities
├── fetch-standings.js      # ESPN standings → standings.json
├── fetch-rss.js            # RSS digest → rss-digest.json
├── sync-configs.js         # Config maintenance: prune, archive, flag needsResearch
├── discover-events.js      # LLM-powered event/athlete discovery (Claude CLI + WebSearch)
├── build-events.js         # Aggregates sport JSONs + curated configs → events.json
├── enrich-events.js        # LLM enrichment (importance, tags, summaries)
├── generate-featured.js    # Claude CLI → featured.json (brief, sections, radar)
├── pipeline-health.js      # Pipeline health report → health-report.json
├── check-quality-regression.js # AI quality regression detection
├── detect-coverage-gaps.js # RSS vs events coverage gap detection
├── merge-open-data.js      # Merges open source + primary data
├── validate-events.js      # Data integrity checks
└── build-ics.js            # Calendar export generator

.github/workflows/
├── update-sports-data.yml  # Data pipeline (every 2 hours)
└── claude-autopilot.yml    # Autonomous improvement agent (nightly)

tests/                      # 279 tests across 18 files (vitest)
AUTOPILOT_ROADMAP.md        # Prioritized task queue for autopilot
```

## Development Notes

- **No build process** - pure static files with embedded CSS
- **Modern JavaScript** - ES6+ features, async/await patterns
- **Norwegian focus** - Europe/Oslo timezone, Norwegian teams prioritized
- **Error resilience** - Multiple fallback layers for robust operation
- **GitHub Pages** - Automatic deployment on push to main branch
- **Ultra-minimal design** - 480px reading column, editorial newspaper aesthetic
- **Sport-organized** - Events grouped by sport with color-coded left borders
- **Click-to-expand** - Event rows expand to show venue, logos, standings, streaming, favorites
- **Must-watch emphasis** - AI enrichment marks importance 4-5 events with subtle accent styling
- **Live scores** - Client-side ESPN polling with pulsing LIVE dot, dynamic brief updates

## Extending the Dashboard

To add a new sport:
1. Add API fetching logic to the GitHub Actions workflow
2. Add sport config to `docs/js/sport-config.js`
3. Events will auto-display via sport-organized layout in `dashboard.js`

To add a curated major event (Olympics, World Cup, etc.):
1. Create a JSON config in `scripts/config/{event}-{year}.json` (see `olympics-2026.json` for format)
2. Events auto-merge into `events.json` during build — no registration needed
3. `generate-featured.js` auto-detects the config and feeds it to Claude for featured content
4. The autopilot should create these configs autonomously (see `AUTOPILOT_ROADMAP.md`)

### Autonomous Discovery

SportSync aspires to zero manual configuration. The discovery pipeline:
- **`sync-configs.js`** runs every pipeline cycle: prunes expired events (>6h old), archives expired configs, flags empty auto-generated configs as `needsResearch: true`
- **`discover-events.js`** runs every pipeline cycle: finds configs needing research, invokes Claude CLI with WebSearch to look up real schedules, Norwegian athletes, and streaming info
- **Athlete refresh**: Configs with `norwegianAthletes` arrays are re-researched every 7 days to catch retirements, nationality changes, and rising stars
- **Dynamic athletes**: `user-context.json` has `dynamicAthletes` config for auto-discovering Norwegian athletes per sport
- **Safeguards**: Max 3 discovery tasks per run, JSON schema validation, `autoGenerated: true` on all machine-written configs
- **7th feedback loop**: `autonomy-scorecard.js` tracks discovery health (log exists + sync script + researched configs)

## Automation Rules

These rules govern automated Claude Code operations via GitHub Actions (`claude-code-action`).

### Protected Paths (never modify automatically)
- `.github/workflows/**`
- `package.json`, `package-lock.json`
- `.env*`
- `.git/**`
- `node_modules/**`

### Allowed Paths
- `scripts/**`
- `tests/**`
- `docs/js/**`
- `docs/index.html`
- `docs/*.md`
- `docs/sw.js`
- `docs/css/**`
- `AUTOPILOT_ROADMAP.md`
- `docs/data/autopilot-log.json`

### Change Limits
- Maximum **8 files** per automated PR
- Maximum **300 lines changed** per automated PR
- One bounded fix per maintenance run

### Risk Classification
- **LOW** — typo fixes, comment updates, test additions → auto-PR
- **MEDIUM** — logic changes, dependency updates, config changes → PR + request review
- **HIGH** — workflow changes, auth changes, data schema changes → skip (create issue only)

### Testing
- Always run `npm test` before committing
- If tests fail, revert changes and report in the PR or issue

### Branch Naming
- All automated branches must use the prefix `claude/`
- Autopilot branches use the prefix `claude/improve-`

### Autopilot

The autopilot workflow (`claude-autopilot.yml`) proactively improves the codebase using a roadmap-driven approach:

- **Roadmap**: `AUTOPILOT_ROADMAP.md` is the prioritized task queue
- **Cadence**: Runs nightly at 03:00 UTC
- **PR label**: `autopilot`
- **Multi-task loop**: The autopilot works through PENDING tasks continuously until it runs out of turns, tasks, or hits an error
- **Auto-merge**: Each task is branched, PR'd, and merged immediately after tests pass
- **Self-curating**: After completing tasks, the autopilot scouts the codebase for new improvement opportunities and appends them to the roadmap
- **Safe stops**: If tests fail or a merge fails, the loop stops — no broken code gets pushed
- **Human control**: Reorder tasks in the roadmap to change priority. Mark tasks `[BLOCKED]` to skip them.
