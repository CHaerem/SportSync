name: Deploy Pages with Previews

on:
  workflow_dispatch:
  repository_dispatch:
    types: [preview-deploy]
  push:
    branches:
      - main
    paths:
      - 'docs/**'

permissions:
  actions: read
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages-deploy
  cancel-in-progress: true

jobs:
  check-runner:
    runs-on: ubuntu-latest
    outputs:
      runner: ${{ steps.check.outputs.runner }}
    steps:
      - id: check
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const { data } = await github.rest.actions.listSelfHostedRunnersForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
              });
              const online = data.runners.some(r => r.status === 'online');
              const runner = online ? '["self-hosted","linux","ARM64"]' : '"ubuntu-latest"';
              core.setOutput('runner', runner);
              console.log(online ? 'Self-hosted runner is online' : 'Falling back to ubuntu-latest');
            } catch (e) {
              core.setOutput('runner', '"ubuntu-latest"');
              console.log(`Runner check failed: ${e.message}`);
            }

  deploy:
    needs: check-runner
    runs-on: ${{ fromJSON(needs.check-runner.outputs.runner) }}
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Assemble site root from main
        run: |
          mkdir -p _site
          cp -r docs/* _site/

      - name: Assemble PR previews
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 10
            });
            for (const pr of prs) {
              const branch = pr.head.ref;
              const slug = branch.replace(/[^a-zA-Z0-9-]/g, '-');
              console.log(`Assembling preview for PR #${pr.number}: ${branch} → /preview/${slug}/`);
              try {
                execSync(`git fetch origin ${branch} --depth=1`, { stdio: 'inherit' });
                execSync(`git checkout origin/${branch} -- docs/`, { stdio: 'inherit' });
                execSync(`mkdir -p _site/preview/${slug}`, { stdio: 'inherit' });
                execSync(`cp -r docs/* _site/preview/${slug}/`, { stdio: 'inherit' });
                execSync(`git checkout main -- docs/`, { stdio: 'inherit' });
                console.log(`  ✓ Preview ready at /preview/${slug}/`);
              } catch (err) {
                console.log(`  ✗ Skipped: ${err.message}`);
                try { execSync(`git checkout main -- docs/`, { stdio: 'inherit' }); } catch {}
              }
            }

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
