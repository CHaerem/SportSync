name: Update Sports Data

on:
  # Run every hour during daytime (06-22 UTC = 07-23 CET)
  # Night hours skipped â€” no meaningful sports data updates at night
  # AI steps (enrichment, featured) skip when event data is unchanged
  schedule:
    - cron: "0 6-22 * * *"

  # Allow manual trigger with runner selection
  workflow_dispatch:
    inputs:
      runner:
        description: 'Runner type'
        required: false
        default: 'self-hosted'
        type: choice
        options:
          - self-hosted
          - ubuntu-latest

  # Run on pushes to main branch (for testing)
  push:
    branches: [main]
    paths:
      - ".github/workflows/update-sports-data.yml"
      - "scripts/**"

concurrency:
  group: sportsync-commits
  cancel-in-progress: false

jobs:
  update-data:
    runs-on: ${{ inputs.runner == 'ubuntu-latest' && 'ubuntu-latest' || fromJSON('["self-hosted","linux","ARM64"]') }}
    permissions:
      contents: write
      issues: write

    steps:
      - uses: ./.github/actions/setup

      - name: Create data directory
        run: mkdir -p docs/data

      - name: Run data pipeline
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: node scripts/run-pipeline.js || true

      - name: Read pipeline result
        id: pipeline
        run: |
          if [ -f docs/data/pipeline-result.json ]; then
            GATE=$(jq -r '.gate // "fail"' docs/data/pipeline-result.json)
          else
            GATE="fail"
          fi
          echo "gate=$GATE" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          if [ "${{ steps.pipeline.outputs.gate }}" = "fail" ]; then
            echo "Gate failed â€” committing health/monitoring files only"
            git add docs/data/health-report.json docs/data/coverage-gaps.json docs/data/ai-quality.json 2>/dev/null || true
          else
            git add docs/data/
            git add docs/data/days/ 2>/dev/null || true
            git add scripts/config/ 2>/dev/null || true
          fi
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ”„ Update sports data with real API sources - $(date -u +"%Y-%m-%d %H:%M UTC")"
            for i in 1 2 3; do
              git push && break
              echo "Push attempt $i failed, rebasing..."
              git pull --rebase origin main || true
              sleep 5
            done
          fi

      - name: Trigger preview deployment
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'preview-deploy'
            });

      - name: Summary
        run: |
          echo "## ðŸ“Š Sports Data Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY
          if [ -f docs/data/pipeline-result.json ]; then
            SUCCESS=$(jq -r '.summary.success // 0' docs/data/pipeline-result.json)
            TOTAL=$(jq -r '.summary.total // 0' docs/data/pipeline-result.json)
            FAILED=$(jq -r '.summary.failed // 0' docs/data/pipeline-result.json)
            SKIPPED=$(jq -r '.summary.skipped // 0' docs/data/pipeline-result.json)
            DURATION=$(jq -r '.duration // 0' docs/data/pipeline-result.json)
            DURATION_S=$((DURATION / 1000))
            echo "- **Pipeline**: $SUCCESS/$TOTAL steps succeeded ($FAILED failed, $SKIPPED skipped) in ${DURATION_S}s" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Football**: $(jq -r '.tournaments | length' docs/data/football.json 2>/dev/null || echo 0) tournaments" >> $GITHUB_STEP_SUMMARY
          echo "- **Golf**: $(jq -r '.tournaments | length' docs/data/golf.json 2>/dev/null || echo 0) tournaments" >> $GITHUB_STEP_SUMMARY
          echo "- **Tennis**: $(jq -r '.tournaments | length' docs/data/tennis.json 2>/dev/null || echo 0) tournaments" >> $GITHUB_STEP_SUMMARY
          echo "- **F1**: $(jq -r '.tournaments[0].events | length' docs/data/f1.json 2>/dev/null || echo 0) races" >> $GITHUB_STEP_SUMMARY
          echo "- **Chess**: $(jq -r '.tournaments | length' docs/data/chess.json 2>/dev/null || echo 0) tournaments" >> $GITHUB_STEP_SUMMARY
          echo "- **Esports**: $(jq -r '.tournaments | length' docs/data/esports.json 2>/dev/null || echo 0) tournaments" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f docs/data/events.json ]; then
            TOTAL_EVENTS=$(jq -r 'length' docs/data/events.json 2>/dev/null || echo 0)
            echo "- **Total Events**: $TOTAL_EVENTS" >> $GITHUB_STEP_SUMMARY
            ENRICHED=$(jq -r '[.[] | select(.importance != null)] | length' docs/data/events.json 2>/dev/null || echo 0)
            echo "- **AI Enriched**: $ENRICHED/$TOTAL_EVENTS events" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f docs/data/health-report.json ]; then
            STATUS=$(jq -r '.status' docs/data/health-report.json 2>/dev/null || echo "unknown")
            ISSUES=$(jq -r '.issues | length' docs/data/health-report.json 2>/dev/null || echo 0)
            echo "- **Pipeline Health**: $STATUS ($ISSUES issues)" >> $GITHUB_STEP_SUMMARY
          fi
          GATE="${{ steps.pipeline.outputs.gate }}"
          if [ "$GATE" = "fail" ]; then
            echo "âš ï¸ Pre-commit gate FAILED â€” only monitoring files committed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Runner**: ${{ runner.name }} (${{ runner.os }})" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Dashboard updated with current week real data only!" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup (self-hosted)
        if: always() && !contains(runner.name, 'GitHub Actions')
        run: rm -rf node_modules 2>/dev/null || true
