name: Claude Autopilot

on:
  schedule:
    - cron: '0 3 * * *' # Nightly at 03:00 UTC
  workflow_dispatch:
    inputs:
      task_override:
        description: 'Override: paste a specific task description to execute instead of reading the roadmap'
        required: false
        type: string

concurrency:
  group: claude-autopilot
  cancel-in-progress: true

jobs:
  autopilot:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - run: npm ci

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: |
            --model claude-opus-4-6
            --max-turns 35
            --allowedTools "Read,Write,Edit,Glob,Grep,Bash(npm:*),Bash(node:*),Bash(git:*),Bash(gh:*),Bash(date:*),Bash(jq:*)"
          prompt: |
            You are the SportSync autopilot — a proactive agent that improves the codebase
            one task at a time. Read CLAUDE.md first for project context and automation rules.

            TASK OVERRIDE: "${{ inputs.task_override }}"

            ## Step 0: Check for open autopilot PRs

            Run: `gh pr list --label autopilot --state open --json number,title`

            If any open PR with the `autopilot` label exists, a previous run failed
            to merge. STOP immediately and create a GitHub issue flagging the stale PR.
            Write to the step summary: "Skipped — open autopilot PR exists: #N".

            ## Step 1: Pick a task

            If TASK OVERRIDE is non-empty, use that as your task description.
            Otherwise, read `AUTOPILOT_ROADMAP.md` and find the FIRST task marked `[PENDING]`.
            If no PENDING tasks exist, skip to Step 5 (scout only) and then stop.

            ## Step 2: Validate the task

            Before starting, verify the task fits automation constraints:
            - Only modify allowed paths (see CLAUDE.md + autopilot additions: `AUTOPILOT_ROADMAP.md`, `docs/sw.js`, `docs/css/**`)
            - Maximum 8 files changed
            - Maximum 300 lines changed
            - Risk must be LOW or MEDIUM (never HIGH)

            If the task violates constraints, mark it `[BLOCKED] exceeds automation limits`
            in the roadmap, commit that change, and move to the next PENDING task.

            ## Step 3: Execute the task

            1. Create a branch: `claude/improve-<short-slug>`
            2. Make the changes needed to complete the task
            3. Run `npm test` — if tests fail, revert ALL changes and create a GitHub issue
               describing what went wrong. Do NOT open a PR with failing tests.
            4. Commit with a descriptive message

            ## Step 4: Open a PR, merge it, and update the roadmap

            1. Push the branch and open a PR with:
               - Clear title describing the improvement
               - Body explaining what changed and why
               - Label: `autopilot`
            2. Immediately merge the PR using: `gh pr merge <number> --merge`
               Tests already passed in Step 3, so merge without waiting.
               If the merge fails, leave the PR open for human review.
            3. After merging, switch back to main and pull the merged changes:
               `git checkout main && git pull`
            4. Update `AUTOPILOT_ROADMAP.md`: change the completed task from `[PENDING]` to
               `[DONE]` and add the PR number, e.g. `[DONE] (PR #42) Fix service worker...`
            5. Commit and push the roadmap update directly to main.

            ## Step 5: Scout for new tasks

            After completing (or skipping) the main task, briefly scan the codebase for
            new improvement opportunities:
            - Run `npm test` and note any issues
            - Scan for new TODO/FIXME comments
            - Check for obvious code quality issues

            If you discover new tasks, append them to the bottom of the appropriate
            priority section in `AUTOPILOT_ROADMAP.md` as `[PENDING]`. Commit these
            additions. Do NOT execute newly discovered tasks in this run.

            ## Step 6: Update the status tracker

            After every run (whether you completed a task, skipped, or hit an error),
            append an entry to `docs/data/autopilot-log.json`. The file contains a
            JSON object with a `"runs"` array. Append one object to that array:

            ```json
            {
              "date": "YYYY-MM-DD",
              "task": "Short description of the task attempted (or 'skipped' / 'no pending tasks')",
              "outcome": "completed|skipped|failed|blocked",
              "pr": null or PR number,
              "details": "Brief explanation of what happened",
              "tests_passed": true or false,
              "files_changed": number of files changed (0 if skipped),
              "scouted": number of new tasks discovered and appended
            }
            ```

            Commit this log update to the same branch as other changes. If you skipped
            (no branch created), commit directly to main.

            Keep only the last 30 entries in the runs array to prevent the file from
            growing indefinitely. If there are more than 30, remove the oldest entries.

            ## Safety constraints

            - Never modify protected paths listed in CLAUDE.md
            - Always run `npm test` before committing. Revert if tests fail.
            - One task per run maximum
            - Never execute tasks you just discovered — only append them
            - Keep changes focused and minimal
