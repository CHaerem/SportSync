name: Claude Autopilot

on:
  schedule:
    - cron: '0 1 * * *' # Nightly at 01:00 UTC (between data pipeline runs)
  workflow_dispatch:
    inputs:
      task_override:
        description: 'Override: paste a specific task description to execute instead of reading the roadmap'
        required: false
        type: string
      single_agent:
        description: 'Focus on a specific domain (data, content, code, ux, or leave empty for all)'
        required: false
        type: string

concurrency:
  group: sportsync-commits
  cancel-in-progress: false

jobs:
  # ──────────────────────────────────────────────────────────────────
  # Phase 0: Pre-flight — shared setup, quota check, baseline tests
  # ──────────────────────────────────────────────────────────────────
  preflight:
    runs-on: [self-hosted, linux, ARM64]
    timeout-minutes: 10
    permissions:
      contents: write
      pull-requests: write
      issues: read
      id-token: write
    outputs:
      gate: ${{ steps.quota.outputs.gate }}
      model: ${{ steps.config.outputs.model }}
      max_turns: ${{ steps.config.outputs.max_turns }}
      allowed_tools: ${{ steps.config.outputs.allowed_tools }}
      tests_pass: ${{ steps.tests.outputs.pass }}
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup

      - name: Install Playwright for visual validation
        run: npx playwright install chromium --with-deps || echo "Playwright install failed — screenshots unavailable this run"

      - name: Check quota headroom
        id: quota
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: node scripts/track-usage.js gate && echo "gate=pass" >> $GITHUB_OUTPUT || echo "gate=skip" >> $GITHUB_OUTPUT

      - name: Resolve autopilot config
        id: config
        if: steps.quota.outputs.gate != 'skip'
        run: node scripts/resolve-autopilot-config.js >> $GITHUB_OUTPUT

      - name: Snapshot usage (before autopilot)
        if: steps.quota.outputs.gate != 'skip'
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: node scripts/track-usage.js snapshot || true

      - name: Run baseline tests
        id: tests
        if: steps.quota.outputs.gate != 'skip'
        run: |
          npm test && echo "pass=true" >> $GITHUB_OUTPUT || echo "pass=false" >> $GITHUB_OUTPUT

      - name: Cleanup (self-hosted)
        if: always() && !contains(runner.name, 'GitHub Actions')
        run: rm -rf node_modules 2>/dev/null || true

  # ──────────────────────────────────────────────────────────────────
  # Main autopilot — single session with specialized subagents
  # Claude Code auto-discovers .claude/agents/ and delegates tasks
  # ──────────────────────────────────────────────────────────────────
  autopilot:
    needs: preflight
    if: needs.preflight.outputs.gate != 'skip'
    runs-on: [self-hosted, linux, ARM64]
    timeout-minutes: 120
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup

      - name: Load orchestrator prompt
        id: load-prompt
        run: |
          # Load the orchestrator prompt and make it available as a step output
          {
            echo 'prompt<<ORCHESTRATOR_EOF'
            cat scripts/agents/orchestrator-prompt.md
            echo ''
            echo 'ORCHESTRATOR_EOF'
          } >> $GITHUB_OUTPUT

      - uses: anthropics/claude-code-action@v1
        id: autopilot
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: |
            --model ${{ needs.preflight.outputs.model || 'claude-opus-4-6' }}
            --max-turns ${{ needs.preflight.outputs.max_turns || '300' }}
            --allowedTools "${{ needs.preflight.outputs.allowed_tools || 'Read,Write,Edit,Glob,Grep,Bash(npm:*),Bash(node:*),Bash(git:*),Bash(gh:*),Bash(date:*),Bash(jq:*)' }}"
          prompt: |
            ${{ steps.load-prompt.outputs.prompt }}

            ---

            TASK OVERRIDE: "${{ inputs.task_override }}"
            DOMAIN FOCUS: "${{ inputs.single_agent }}"
            BASELINE TESTS: ${{ needs.preflight.outputs.tests_pass }}

            Execute the orchestrator workflow above. You have specialized subagents
            available in .claude/agents/ (data-agent, content-agent, code-agent, ux-agent).
            Delegate tasks to the appropriate subagent using the Task tool.

            If TASK OVERRIDE is non-empty, execute that single task.
            If DOMAIN FOCUS is set, only work on tasks for that domain.

      - name: Report autopilot usage
        if: always()
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: node scripts/track-usage.js report autopilot || true

      - name: Cleanup (self-hosted)
        if: always() && !contains(runner.name, 'GitHub Actions')
        run: rm -rf node_modules 2>/dev/null || true
