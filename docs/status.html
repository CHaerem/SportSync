<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
	<meta name="description" content="SportSync system status — autonomy score, pipeline health, AI quality metrics.">
	<meta name="theme-color" content="#d97757">
	<title>SportSync — System Status</title>
	<style>
		:root {
			--bg: #faf9f5;
			--bg-secondary: #f0efe8;
			--fg: #3d3929;
			--muted: #8b8580;
			--border: #e8e5dc;
			--border-strong: #3d3929;
			--accent: #d97757;
			--radius: 12px;
			--max-w: 480px;
			--font: system-ui, -apple-system, sans-serif;
			--font-serif: ui-serif, Georgia, Cambria, 'Times New Roman', serif;
			--shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
			--green: #2ecc71;
			--amber: #f39c12;
			--red: #e74c3c;
		}
		.dark {
			--bg: #1a1816;
			--bg-secondary: #242220;
			--fg: #faf9f5;
			--muted: #9a958e;
			--border: #2d2a26;
			--border-strong: #faf9f5;
			--shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
		}
		* { margin: 0; padding: 0; box-sizing: border-box; }

		body {
			font-family: var(--font);
			background: var(--bg);
			color: var(--fg);
			line-height: 1.6;
			font-size: 15px;
			font-weight: 400;
			-webkit-font-smoothing: antialiased;
		}

		.wrap {
			max-width: var(--max-w);
			margin: 0 auto;
			padding: 40px 24px 60px;
		}

		header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			margin-bottom: 32px;
		}
		header h1 {
			font-family: var(--font-serif);
			font-size: 1.15rem;
			font-weight: 400;
			letter-spacing: -0.01em;
			color: var(--fg);
		}
		header h1 a {
			color: var(--fg);
			text-decoration: none;
		}
		header h1 a:hover { color: var(--accent); }
		.header-sub {
			color: var(--muted);
			font-size: 0.9em;
		}
		#themeToggle {
			background: none;
			border: none;
			font-size: 1rem;
			cursor: pointer;
			padding: 4px;
			line-height: 1;
			opacity: 0.5;
			transition: opacity 0.15s;
		}
		#themeToggle:hover { opacity: 0.8; }

		/* --- Cards --- */
		.card {
			background: var(--bg-secondary);
			border-radius: var(--radius);
			padding: 18px 20px;
			margin-bottom: 16px;
			box-shadow: var(--shadow);
		}
		.card-header {
			font-size: 0.65rem;
			font-weight: 600;
			text-transform: uppercase;
			letter-spacing: 0.1em;
			color: var(--accent);
			margin-bottom: 12px;
		}

		/* --- Autonomy score --- */
		.score-big {
			font-size: 2.4rem;
			font-weight: 300;
			letter-spacing: -0.02em;
			line-height: 1.1;
		}
		.score-label {
			font-size: 0.7rem;
			color: var(--muted);
			margin-bottom: 12px;
		}
		.score-bar {
			height: 4px;
			border-radius: 2px;
			background: var(--border);
			overflow: hidden;
			margin-bottom: 16px;
		}
		.score-bar-fill {
			height: 100%;
			border-radius: 2px;
			transition: width 0.4s;
		}

		/* --- Loop rows --- */
		.loop-row {
			display: flex;
			align-items: center;
			gap: 10px;
			padding: 5px 0;
			font-size: 0.78rem;
			border-bottom: 1px solid var(--border);
		}
		.loop-row:last-child { border-bottom: none; }
		.loop-icon { flex-shrink: 0; font-size: 0.85rem; }
		.loop-name { font-weight: 500; min-width: 110px; }
		.loop-detail { color: var(--muted); font-size: 0.7rem; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

		/* --- Status badge --- */
		.status-badge {
			display: inline-block;
			font-size: 0.6rem;
			font-weight: 600;
			text-transform: uppercase;
			letter-spacing: 0.06em;
			padding: 2px 10px;
			border-radius: 10px;
			margin-bottom: 10px;
		}
		.status-badge.healthy { background: rgba(46, 204, 113, 0.15); color: var(--green); }
		.status-badge.warning { background: rgba(243, 156, 18, 0.15); color: var(--amber); }
		.status-badge.critical { background: rgba(231, 76, 60, 0.15); color: var(--red); }

		/* --- Metric rows --- */
		.metric-row {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 4px 0;
			font-size: 0.78rem;
		}
		.metric-label { color: var(--muted); }
		.metric-value { font-weight: 500; font-variant-numeric: tabular-nums; }

		/* --- Issue list --- */
		.issue-item {
			font-size: 0.72rem;
			padding: 3px 0;
			color: var(--muted);
		}
		.issue-dot {
			display: inline-block;
			width: 6px; height: 6px;
			border-radius: 50%;
			margin-right: 6px;
			vertical-align: middle;
		}
		.issue-dot.critical { background: var(--red); }
		.issue-dot.warning { background: var(--amber); }

		/* --- Ops overview --- */
		.ops-row {
			display: flex;
			align-items: center;
			gap: 10px;
			padding: 6px 0;
			font-size: 0.78rem;
			border-bottom: 1px solid var(--border);
		}
		.ops-row:last-child { border-bottom: none; }
		.ops-dot {
			width: 8px; height: 8px;
			border-radius: 50%;
			flex-shrink: 0;
		}
		.ops-dot.green { background: var(--green); }
		.ops-dot.amber { background: var(--amber); }
		.ops-dot.red { background: var(--red); }
		.ops-label { font-weight: 500; min-width: 80px; }
		.ops-detail { color: var(--muted); font-size: 0.72rem; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

		/* --- Sparkline --- */
		.sparkline {
			display: flex;
			align-items: flex-end;
			gap: 2px;
			height: 40px;
			margin-top: 8px;
		}
		.spark-bar {
			flex: 1;
			min-width: 3px;
			max-width: 12px;
			border-radius: 2px 2px 0 0;
			background: var(--accent);
			opacity: 0.7;
			transition: opacity 0.15s;
		}
		.spark-bar:last-child { opacity: 1; }
		.spark-bar:hover { opacity: 1; }

		/* --- Autopilot log --- */
		.log-item {
			padding: 6px 0;
			border-bottom: 1px solid var(--border);
			font-size: 0.78rem;
		}
		.log-item:last-child { border-bottom: none; }
		.log-task { font-weight: 400; }
		.log-meta {
			font-size: 0.65rem;
			color: var(--muted);
			margin-top: 2px;
		}
		.log-pr {
			color: var(--accent);
			text-decoration: none;
			font-size: 0.65rem;
		}
		.log-pr:hover { opacity: 0.7; }

		/* --- Next actions --- */
		.action-item {
			font-size: 0.75rem;
			padding: 4px 0;
			color: var(--fg);
		}

		/* --- Empty state --- */
		.empty-state {
			font-size: 0.75rem;
			color: var(--muted);
			font-style: italic;
			padding: 4px 0;
		}

		/* --- Summary --- */
		.summary {
			font-size: 0.82rem;
			color: var(--fg);
			line-height: 1.6;
			margin-bottom: 16px;
			font-style: italic;
		}

		/* --- Loading --- */
		.loading {
			text-align: center;
			padding: 48px 0;
			color: var(--muted);
			font-size: 0.8rem;
		}

		@media (prefers-reduced-motion: reduce) {
			*, *::before, *::after {
				animation-duration: 0.01ms !important;
				transition-duration: 0.01ms !important;
			}
		}

		/* --- Autopilot impact --- */
		.impact-stats { display: flex; gap: 12px; margin-bottom: 14px; }
		.impact-stat { flex: 1; text-align: center; }
		.impact-stat-value { font-size: 1.4rem; font-weight: 300; }
		.impact-stat-label { font-size: 0.6rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; }
		.impact-cats { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 14px; }
		.impact-cat { font-size: 0.6rem; padding: 2px 8px; border-radius: 10px; background: var(--bg); border: 1px solid var(--border); color: var(--muted); }
		.lesson-item { font-size: 0.7rem; color: var(--muted); font-style: italic; padding: 3px 0; border-bottom: 1px solid var(--border); }
		.lesson-item:last-child { border-bottom: none; }

		@media (max-width: 380px) {
			.wrap { padding: 24px 16px 40px; }
			.impact-stats { gap: 8px; }
		}
	</style>
</head>
<body>
	<div class="wrap">
		<header>
			<h1><a href="./">SportSync</a> <span class="header-sub">System</span></h1>
			<button id="themeToggle" aria-label="Toggle dark mode">&#127769;</button>
		</header>

		<div id="ops"></div>
		<div id="summary"></div>
		<div id="autonomy"><div class="loading">Loading...</div></div>
		<div id="autopilot"></div>
		<div id="pipeline"></div>
		<div id="quality"></div>
		<div id="trend"></div>
		<div id="sanity"></div>
		<div id="gaps"></div>
		<div id="quota"></div>
		<div id="freshness"></div>
	</div>

	<script>
		// Theme toggle
		(function() {
			const saved = localStorage.getItem('theme');
			if (saved === 'dark' || (!saved && matchMedia('(prefers-color-scheme: dark)').matches)) {
				document.documentElement.classList.add('dark');
			}
			document.getElementById('themeToggle').addEventListener('click', () => {
				const isDark = document.documentElement.classList.toggle('dark');
				localStorage.setItem('theme', isDark ? 'dark' : 'light');
			});
		})();

		const REPO_URL = 'https://github.com/christopherhaerem/SportSync';

		async function fetchJSON(file) {
			try {
				const r = await fetch('data/' + file, { cache: 'no-cache' });
				if (!r.ok) return null;
				return r.json();
			} catch { return null; }
		}

		function timeAgo(iso) {
			if (!iso) return 'unknown';
			const diff = Date.now() - new Date(iso).getTime();
			const mins = Math.floor(diff / 60000);
			if (mins < 1) return 'just now';
			if (mins < 60) return mins + 'm ago';
			const hrs = Math.floor(mins / 60);
			if (hrs < 24) return hrs + 'h ' + (mins % 60) + 'm ago';
			return Math.floor(hrs / 24) + 'd ago';
		}

		function timeUntil(iso) {
			if (!iso) return 'unknown';
			const diff = new Date(iso).getTime() - Date.now();
			if (diff <= 0) return 'now';
			const mins = Math.floor(diff / 60000);
			if (mins < 60) return mins + 'm';
			const hrs = Math.floor(mins / 60);
			if (hrs < 24) return hrs + 'h ' + (mins % 60) + 'm';
			return Math.floor(hrs / 24) + 'd';
		}

		function statusColor(score) {
			if (score >= 0.8) return 'var(--green)';
			if (score >= 0.5) return 'var(--amber)';
			return 'var(--red)';
		}

		const LOOP_LABELS = {
			featuredQuality: 'Featured Quality',
			enrichmentQuality: 'Enrichment Quality',
			coverageGaps: 'Coverage Gaps',
			pipelineHealth: 'Pipeline Health',
			watchPlan: 'Watch Plan',
			codeHealth: 'Code Health',
			eventDiscovery: 'Event Discovery',
			scheduleVerification: 'Schedule Verification',
			resultsHealth: 'Results Health',
			snapshotHealth: 'Snapshot Health'
		};

		function renderOpsOverview(pipelineResult, meta, autopilotLog, health) {
			const el = document.getElementById('ops');
			const rows = [];

			// 1. Pipeline status
			const staleMs = meta?.lastUpdate ? Date.now() - new Date(meta.lastUpdate).getTime() : Infinity;
			const staleH = staleMs / 3600000;
			const pSum = pipelineResult?.summary || {};
			let pDot = 'green', pText = '';
			if (pipelineResult) {
				pText = timeAgo(pipelineResult.completedAt || meta?.lastUpdate);
				if (pSum.total) pText += ' \u00b7 ' + pSum.success + '/' + pSum.total + ' steps';
				if (pipelineResult.gate === 'fail' || staleH > 4) pDot = 'red';
				else if ((pSum.failed || 0) > 0 || (pSum.skipped || 0) > 0 || staleH > 2) pDot = 'amber';
			} else {
				pText = meta?.lastUpdate ? timeAgo(meta.lastUpdate) : 'No data';
				pDot = staleH > 4 ? 'red' : staleH > 2 ? 'amber' : 'green';
			}
			rows.push({ label: 'Pipeline', dot: pDot, detail: pText });

			// 2. Autopilot status
			const runs = autopilotLog?.runs || [];
			const lastRun = runs.length > 0 ? runs[runs.length - 1] : null;
			let aDot = 'red', aText = 'No runs recorded';
			if (lastRun) {
				const daysAgo = Math.floor((Date.now() - new Date(lastRun.date).getTime()) / 86400000);
				const ok = lastRun.outcome === 'completed' || lastRun.outcome === 'repaired';
				if (ok && daysAgo <= 1) aDot = 'green';
				else if (daysAgo <= 3) aDot = 'amber';
				else aDot = 'red';
				if (!ok) aDot = 'red';
				const when = daysAgo === 0 ? 'Today' : daysAgo === 1 ? 'Yesterday' : daysAgo + 'd ago';
				aText = when;
				if (lastRun.task) aText += ' \u00b7 ' + lastRun.task.slice(0, 40) + (lastRun.task.length > 40 ? '\u2026' : '');
				if (lastRun.pr) aText += ' <a class="log-pr" href="' + REPO_URL + '/pull/' + lastRun.pr + '" target="_blank" rel="noopener">#' + lastRun.pr + '</a>';
			}
			rows.push({ label: 'Autopilot', dot: aDot, detail: aText });

			// 3. Dashboard freshness
			let dDot = 'green', dText = '';
			if (meta?.lastUpdate) {
				dText = 'Data ' + timeAgo(meta.lastUpdate);
				if (staleH > 4) dDot = 'red';
				else if (staleH > 2) dDot = 'amber';
			} else {
				dText = 'No data'; dDot = 'red';
			}
			rows.push({ label: 'Dashboard', dot: dDot, detail: dText });

			// 4. Issues
			const issues = health?.issues || [];
			const warnings = issues.filter(i => i.severity === 'warning').length;
			const criticals = issues.filter(i => i.severity === 'critical').length;
			let iDot = 'green', iText = 'No issues';
			if (criticals > 0) { iDot = 'red'; iText = criticals + ' critical, ' + warnings + ' warning' + (warnings !== 1 ? 's' : ''); }
			else if (warnings > 0) { iDot = 'amber'; iText = warnings + ' warning' + (warnings !== 1 ? 's' : ''); }
			rows.push({ label: 'Issues', dot: iDot, detail: iText });

			const rowsHtml = rows.map(r =>
				'<div class="ops-row">' +
				'<span class="ops-dot ' + r.dot + '"></span>' +
				'<span class="ops-label">' + r.label + '</span>' +
				'<span class="ops-detail">' + r.detail + '</span>' +
				'</div>'
			).join('');

			el.innerHTML = '<div class="card">' +
				'<div class="card-header">Ops Overview</div>' +
				rowsHtml +
				'</div>';
		}

		function renderSummary(health) {
			const el = document.getElementById('summary');
			const raw = health?.statusSummary;
			const text = typeof raw === 'string' ? raw : raw?.text;
			if (!text) { el.innerHTML = ''; return; }
			el.innerHTML = '<div class="summary">' + text + '</div>';
		}

		function renderAutonomy(report, trend) {
			const el = document.getElementById('autonomy');
			if (!report) { el.innerHTML = '<div class="card"><div class="card-header">Autonomy</div><div class="empty-state">No data available</div></div>'; return; }
			const pct = Math.round(report.overallScore * 100);
			const loopRows = Object.entries(report.loops || {}).map(([key, loop]) => {
				const icon = loop.status === 'closed' ? '&#9679;' : loop.status === 'partial' ? '&#9681;' : '&#9675;';
				const color = loop.status === 'closed' ? 'var(--green)' : loop.status === 'partial' ? 'var(--amber)' : 'var(--red)';
				return '<div class="loop-row">' +
					'<span class="loop-icon" style="color:' + color + '">' + icon + '</span>' +
					'<span class="loop-name">' + (LOOP_LABELS[key] || key) + '</span>' +
					'<span class="loop-detail" title="' + (loop.details || '').replace(/"/g, '&quot;') + '">' + (loop.details || '') + '</span>' +
					'</div>';
			}).join('');

			let trendHtml = '';
			if (Array.isArray(trend) && trend.length > 1) {
				const last20 = trend.slice(-20);
				const bars = last20.map(e => {
					const h = Math.max(2, e.overallScore * 40);
					const title = new Date(e.timestamp).toLocaleString('en-GB', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) + ': ' + Math.round(e.overallScore * 100) + '%';
					return '<div class="spark-bar" style="height:' + h + 'px" title="' + title + '"></div>';
				}).join('');
				trendHtml = '<div style="margin-top:4px;margin-bottom:12px"><div style="font-size:0.65rem;color:var(--muted);margin-bottom:4px">Autonomy trend (last ' + last20.length + ' snapshots)</div>' +
					'<div class="sparkline">' + bars + '</div></div>';
			}

			let actionsHtml = '';
			if (report.nextActions && report.nextActions.length > 0) {
				actionsHtml = '<div style="margin-top:12px"><div class="card-header" style="margin-bottom:6px">Next Actions</div>' +
					report.nextActions.map(a => '<div class="action-item">' + a + '</div>').join('') + '</div>';
			}

			el.innerHTML = '<div class="card">' +
				'<div class="card-header">Autonomy Score</div>' +
				'<div class="score-big">' + pct + '%</div>' +
				'<div class="score-label">' + report.loopsClosed + ' of ' + report.loopsTotal + ' feedback loops closed</div>' +
				'<div class="score-bar"><div class="score-bar-fill" style="width:' + pct + '%;background:' + statusColor(report.overallScore) + '"></div></div>' +
				trendHtml +
				loopRows +
				actionsHtml +
				'</div>';
		}

		function renderPipeline(health) {
			const el = document.getElementById('pipeline');
			if (!health) { el.innerHTML = ''; return; }
			const badgeClass = health.status === 'healthy' ? 'healthy' : health.status === 'warning' ? 'warning' : 'critical';
			const coverage = Object.entries(health.sportCoverage || {}).map(([sport, data]) => {
				const delta = data.delta != null && data.delta !== 0 ? ' (' + (data.delta > 0 ? '+' : '') + data.delta + ')' : '';
				return '<div class="metric-row"><span class="metric-label">' + sport + '</span><span class="metric-value">' + data.count + ' events' + delta + '</span></div>';
			}).join('');

			const issues = (health.issues || []).slice(0, 6).map(i =>
				'<div class="issue-item"><span class="issue-dot ' + i.severity + '"></span>' + i.message + '</div>'
			).join('');

			const standingsHtml = health.standingsHealth ? '<div style="margin-top:8px">' +
				Object.entries(health.standingsHealth).map(([k, v]) =>
					'<div class="metric-row"><span class="metric-label">' + k + '</span><span class="metric-value" style="color:' + (v ? 'var(--green)' : 'var(--red)') + '">' + (v ? 'OK' : 'Down') + '</span></div>'
				).join('') + '</div>' : '';

			el.innerHTML = '<div class="card">' +
				'<div class="card-header">Pipeline Health</div>' +
				'<span class="status-badge ' + badgeClass + '">' + health.status + '</span>' +
				'<div class="metric-row"><span class="metric-label">Total events</span><span class="metric-value">' + (health.eventCount || 0) + '</span></div>' +
				coverage +
				standingsHtml +
				(issues ? '<div style="margin-top:8px">' + issues + '</div>' : '') +
				'</div>';
		}

		function renderQuality(quality) {
			const el = document.getElementById('quality');
			if (!quality) { el.innerHTML = ''; return; }
			const ed = quality.editorial || {};
			const en = quality.enrichment || {};
			const ft = quality.featured || {};

			const metricsHtml = Object.entries(ed.metrics || {}).map(([k, v]) => {
				const label = k.replace(/([A-Z])/g, ' $1').replace(/^./, c => c.toUpperCase());
				return '<div class="metric-row"><span class="metric-label">' + label + '</span><span class="metric-value">' + Math.round(v * 100) + '%</span></div>';
			}).join('');

			const hintsHtml = en.hintsApplied && en.hintsApplied.length > 0
				? '<div style="margin-top:6px;font-size:0.7rem;color:var(--muted)">Hints: ' + en.hintsApplied.join(', ') + '</div>' : '';

			el.innerHTML = '<div class="card">' +
				'<div class="card-header">AI Quality</div>' +
				'<div class="metric-row"><span class="metric-label">Editorial score</span><span class="metric-value">' + (ed.score || '—') + '</span></div>' +
				'<div class="metric-row"><span class="metric-label">Enrichment score</span><span class="metric-value">' + (en.score || '—') + '</span></div>' +
				'<div class="metric-row"><span class="metric-label">Featured score</span><span class="metric-value">' + (ft.score || '—') + '</span></div>' +
				'<div class="metric-row"><span class="metric-label">Featured provider</span><span class="metric-value">' + (ft.provider || '—') + '</span></div>' +
				'<div class="metric-row"><span class="metric-label">Generation time</span><span class="metric-value">' + (ft.generationMs != null ? ft.generationMs + 'ms' : '—') + '</span></div>' +
				metricsHtml +
				hintsHtml +
				'</div>';
		}

		function fmtTokens(n) {
			if (n == null || n === 0) return '0';
			if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
			if (n >= 1000) return (n / 1000).toFixed(1) + 'k';
			return String(n);
		}

		// renderTokens removed — consolidated into renderQuota below

		function renderTrend(history) {
			const el = document.getElementById('trend');
			if (!history || !history.length) { el.innerHTML = ''; return; }
			const last20 = history.slice(-20);
			const bars = last20.map((entry, i) => {
				const score = (entry.editorial && entry.editorial.score) || 0;
				const h = Math.max(2, (score / 100) * 40);
				const title = new Date(entry.timestamp).toLocaleString('en-GB', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) + ': ' + score;
				return '<div class="spark-bar" style="height:' + h + 'px" title="' + title + '"></div>';
			}).join('');

			el.innerHTML = '<div class="card">' +
				'<div class="card-header">Quality Trend (last ' + last20.length + ' runs)</div>' +
				'<div class="sparkline">' + bars + '</div>' +
				'</div>';
		}

		function renderSanity(sanity) {
			const el = document.getElementById('sanity');
			if (!sanity) { el.innerHTML = ''; return; }
			const s = sanity.summary || {};
			const badgeClass = sanity.pass ? 'healthy' : 'critical';
			const badgeText = sanity.pass ? 'pass' : 'fail';
			const findingsHtml = (sanity.findings || []).map(f => {
				const dotClass = f.severity === 'critical' ? 'critical' : 'warning';
				return '<div class="issue-item"><span class="issue-dot ' + dotClass + '"></span>' + f.message + '</div>';
			}).join('');

			el.innerHTML = '<div class="card">' +
				'<div class="card-header">Sanity Check</div>' +
				'<span class="status-badge ' + badgeClass + '">' + badgeText + '</span>' +
				' <span style="font-size:0.65rem;color:var(--muted)">' + (sanity.provider || '') + ' &middot; ' + timeAgo(sanity.generatedAt) + '</span>' +
				'<div class="metric-row"><span class="metric-label">Findings</span><span class="metric-value">' + (s.total || 0) + '</span></div>' +
				(s.critical > 0 ? '<div class="metric-row"><span class="metric-label">Critical</span><span class="metric-value" style="color:var(--red)">' + s.critical + '</span></div>' : '') +
				(s.warning > 0 ? '<div class="metric-row"><span class="metric-label">Warnings</span><span class="metric-value" style="color:var(--amber)">' + s.warning + '</span></div>' : '') +
				(findingsHtml || '<div class="empty-state">No issues found</div>') +
				'</div>';
		}

		function renderGaps(gaps) {
			const el = document.getElementById('gaps');
			if (!gaps) { el.innerHTML = ''; return; }
			const summary = gaps.summary || {};
			const gapList = (gaps.gaps || []).slice(0, 5).map(g =>
				'<div class="issue-item">' + (g.headline || g.title || JSON.stringify(g)) + '</div>'
			).join('');

			el.innerHTML = '<div class="card">' +
				'<div class="card-header">Coverage Gaps</div>' +
				'<div class="metric-row"><span class="metric-label">Total gaps</span><span class="metric-value">' + (summary.totalGapsDetected || 0) + '</span></div>' +
				'<div class="metric-row"><span class="metric-label">Actionable</span><span class="metric-value">' + (summary.actionableGaps || 0) + '</span></div>' +
				'<div class="metric-row"><span class="metric-label">Informational</span><span class="metric-value">' + (summary.informationalGaps || 0) + '</span></div>' +
				(gapList || '<div class="empty-state">No coverage gaps detected</div>') +
				'</div>';
		}

		function categorizeTask(run) {
			const text = ((run.task || '') + ' ' + (run.details || '')).toLowerCase();
			if (/aria|alt text|a11y|focus|accessible|screen.?reader/.test(text)) return 'Accessibility';
			if (/\btest|tests|unit test|spec\b/.test(text)) return 'Testing';
			if (/\badd\b|render|visualize|implement|feature/.test(text)) return 'Features';
			if (/remove|dead code|fix|cleanup|refactor|simplify|rename/.test(text)) return 'Code Quality';
			if (/guard|validation|hide|standings|data|stale|freshness/.test(text)) return 'Data Quality';
			return 'Other';
		}

		function renderAutopilot(log) {
			const el = document.getElementById('autopilot');
			if (!log || !log.runs || !log.runs.length) { el.innerHTML = ''; return; }
			const completed = log.runs.filter(r => r.outcome === 'completed');

			// Header stats
			const prsMerged = completed.filter(r => r.pr).length;
			const tasksCompleted = completed.length;
			const filesImproved = completed.reduce((s, r) => s + (r.files_changed || 0), 0);

			const statsHtml = '<div class="impact-stats">' +
				'<div class="impact-stat"><div class="impact-stat-value">' + prsMerged + '</div><div class="impact-stat-label">PRs Merged</div></div>' +
				'<div class="impact-stat"><div class="impact-stat-value">' + tasksCompleted + '</div><div class="impact-stat-label">Tasks Done</div></div>' +
				'<div class="impact-stat"><div class="impact-stat-value">' + filesImproved + '</div><div class="impact-stat-label">Files Improved</div></div>' +
				'</div>';

			// Categories
			const cats = {};
			completed.forEach(r => {
				const cat = categorizeTask(r);
				cats[cat] = (cats[cat] || 0) + 1;
			});
			const topCats = Object.entries(cats).sort((a, b) => b[1] - a[1]).slice(0, 3);
			const catsHtml = topCats.length > 0
				? '<div class="impact-cats">' + topCats.map(([cat, count]) => '<span class="impact-cat">' + cat + ' (' + count + ')</span>').join('') + '</div>'
				: '';

			// Recent activity
			const last5 = completed.slice(-5).reverse();
			const itemsHtml = last5.map(run => {
				const prLink = run.pr ? ' <a class="log-pr" href="' + REPO_URL + '/pull/' + run.pr + '" target="_blank" rel="noopener">#' + run.pr + '</a>' : '';
				const cat = categorizeTask(run);
				const detail = run.details ? '<div style="font-size:0.65rem;color:var(--muted);margin-top:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + run.details.slice(0, 80) + (run.details.length > 80 ? '...' : '') + '</div>' : '';
				return '<div class="log-item">' +
					'<div class="log-task">' + run.task + ' <span class="impact-cat">' + cat + '</span></div>' +
					detail +
					'<div class="log-meta">' + run.date + prLink + (run.files_changed ? ' &middot; ' + run.files_changed + ' files' : '') + '</div>' +
					'</div>';
			}).join('');

			// Lessons learned
			const lessons = [];
			const seen = new Set();
			for (let i = log.runs.length - 1; i >= 0 && lessons.length < 3; i--) {
				const r = log.runs[i];
				if (r.lesson && !seen.has(r.lesson)) {
					seen.add(r.lesson);
					lessons.push(r.lesson);
				}
			}
			const lessonsHtml = lessons.length > 0
				? '<div style="margin-top:10px"><div class="card-header" style="margin-bottom:4px">Lessons Learned</div>' +
					lessons.map(l => '<div class="lesson-item">' + l + '</div>').join('') + '</div>'
				: '';

			el.innerHTML = '<div class="card">' +
				'<div class="card-header">Autopilot Impact</div>' +
				statsHtml +
				catsHtml +
				'<div style="margin-top:2px"><div class="card-header" style="margin-bottom:4px">Recent Activity</div>' + itemsHtml + '</div>' +
				lessonsHtml +
				'</div>';
		}

		function renderFreshness(meta) {
			const el = document.getElementById('freshness');
			if (!meta) { el.innerHTML = ''; return; }
			el.innerHTML = '<div class="card">' +
				'<div class="card-header">Data Freshness</div>' +
				'<div class="metric-row"><span class="metric-label">Last update</span><span class="metric-value">' + timeAgo(meta.lastUpdate) + '</span></div>' +
				'<div class="metric-row"><span class="metric-label">Next expected</span><span class="metric-value">' + (meta.nextUpdate ? new Date(meta.nextUpdate).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', timeZone: meta.timezone || 'Europe/Oslo' }) : '—') + '</span></div>' +
				'<div class="metric-row"><span class="metric-label">Timezone</span><span class="metric-value">' + (meta.timezone || '—') + '</span></div>' +
				'</div>';
		}

		function fmtDuration(ms) {
			if (!ms) return '0m';
			const mins = Math.round(ms / 60000);
			if (mins < 60) return mins + 'm';
			const hrs = Math.floor(mins / 60);
			return hrs + 'h ' + (mins % 60) + 'm';
		}

		function renderQuota(usage, quality, history) {
			const el = document.getElementById('quota');
			const c = usage?.current || {};
			const share = usage?.sportsyncShare || {};
			const gate = usage?.gateConfig || {};
			const runs = usage?.runs || [];
			const budget = usage?.budget || {};

			const utilBar = (label, pct, resetIso) => {
				if (pct == null) return '';
				const p = Math.min(100, Math.max(0, pct));
				const color = p > 80 ? 'var(--red)' : p > 60 ? 'var(--amber)' : 'var(--green)';
				let resetHtml = '';
				if (resetIso) {
					const resetDate = new Date(resetIso);
					resetHtml = '<span style="font-size:0.65rem;color:var(--muted);margin-left:4px">' +
						(resetDate > new Date() ? 'resets ' + timeUntil(resetIso) : 'reset ' + timeAgo(resetIso)) + '</span>';
				}
				return '<div class="metric-row"><span class="metric-label">' + label + '</span><span class="metric-value">' + pct + '%' + resetHtml + '</span></div>' +
					'<div class="score-bar"><div class="score-bar-fill" style="width:' + p + '%;background:' + color + '"></div></div>';
			};

			// Quota utilization
			const u5 = c.fiveHour?.utilization;
			const u7 = c.sevenDay?.utilization;
			let utilHtml = '';
			if (u5 != null || u7 != null) {
				utilHtml = utilBar('5-hour window', u5, c.fiveHour?.resets_at) + utilBar('7-day window', u7, c.sevenDay?.resets_at);
			} else {
				utilHtml = '<div style="font-size:0.72rem;color:var(--muted);margin-bottom:8px;font-style:italic">Quota data unavailable</div>';
			}

			// Per-step token breakdown from ai-quality.json
			const enrichUsage = quality?.enrichment?.tokenUsage || null;
			const featuredUsage = quality?.featured?.tokenUsage || null;
			const discoveryUsage = quality?.discovery?.tokenUsage || null;
			const multiDayUsage = quality?.multiDay?.tokenUsage || null;
			const steps = [];
			const addStep = (name, u) => { if (u) steps.push({ label: name + (u.estimated ? ' (est)' : ''), usage: u }); };
			addStep('Enrichment', enrichUsage);
			addStep('Featured', featuredUsage);
			addStep('Discovery', discoveryUsage);
			addStep('Multi-day', multiDayUsage);

			let breakdownHtml = '';
			if (steps.length > 0) {
				const maxTok = Math.max(...steps.map(s => (s.usage.input || 0) + (s.usage.output || 0)), 1);
				breakdownHtml = '<div style="margin-top:8px;border-top:1px solid var(--border);padding-top:8px">' +
					'<div style="font-size:0.65rem;color:var(--muted);margin-bottom:6px">This run</div>' +
					steps.map(s => {
						const tok = (s.usage.input || 0) + (s.usage.output || 0);
						const pct = Math.max(2, Math.round((tok / maxTok) * 100));
						return '<div style="margin-bottom:6px"><div style="display:flex;justify-content:space-between;font-size:0.72rem;margin-bottom:2px"><span class="metric-label">' + s.label + '</span><span class="metric-value">' + fmtTokens(tok) + '</span></div>' +
							'<div class="score-bar"><div class="score-bar-fill" style="width:' + pct + '%;background:var(--accent)"></div></div></div>';
					}).join('') + '</div>';
			}

			// Token trend sparkline
			let sparkHtml = '';
			if (Array.isArray(history) && history.length > 0) {
				const last20 = history.slice(-20).map(e => e.tokenUsage?.total?.total || 0);
				const maxVal = Math.max(...last20, 1);
				if (last20.some(v => v > 0)) {
					sparkHtml = '<div style="margin-top:10px"><div style="font-size:0.65rem;color:var(--muted);margin-bottom:4px">Token trend (last ' + last20.length + ' runs)</div>' +
						'<div class="sparkline">' +
						last20.map(v => '<div class="spark-bar" style="height:' + Math.max(2, (v / maxVal) * 40) + 'px"></div>').join('') +
						'</div></div>';
				}
			}

			// Budget
			let budgetHtml = '';
			if (budget.dailyBudget) {
				const dPct = Math.min(100, budget.dailyPct || 0);
				const wPct = Math.min(100, budget.weeklyPct || 0);
				const dColor = dPct > 80 ? 'var(--red)' : dPct > 60 ? 'var(--amber)' : 'var(--green)';
				const wColor = wPct > 80 ? 'var(--red)' : wPct > 60 ? 'var(--amber)' : 'var(--green)';
				budgetHtml = '<div style="margin-top:10px;border-top:1px solid var(--border);padding-top:8px">' +
					'<div style="font-size:0.65rem;color:var(--muted);margin-bottom:6px">Budget</div>' +
					'<div class="metric-row"><span class="metric-label">Daily (' + fmtTokens(budget.dailyBudget) + ')</span><span class="metric-value">' + dPct + '%</span></div>' +
					'<div class="score-bar"><div class="score-bar-fill" style="width:' + dPct + '%;background:' + dColor + '"></div></div>' +
					'<div class="metric-row"><span class="metric-label">Weekly (' + fmtTokens(budget.weeklyBudget) + ')</span><span class="metric-value">' + wPct + '%</span></div>' +
					'<div class="score-bar"><div class="score-bar-fill" style="width:' + wPct + '%;background:' + wColor + '"></div></div>' +
					'</div>';
			}

			// Run counts
			const fiveHAgo = Date.now() - 5 * 3600000;
			const recent5h = runs.filter(r => new Date(r.timestamp).getTime() > fiveHAgo).length;
			const runsHtml = runs.length > 0 ? '<div style="margin-top:8px;border-top:1px solid var(--border);padding-top:8px">' +
				'<div style="font-size:0.65rem;color:var(--muted);margin-bottom:6px">Pipeline activity</div>' +
				'<div class="metric-row"><span class="metric-label">Runs (5h)</span><span class="metric-value">' + recent5h + '</span></div>' +
				'<div class="metric-row"><span class="metric-label">Pipeline runs (7d)</span><span class="metric-value">' + (share.pipelineRuns || 0) + '</span></div>' +
				'<div class="metric-row"><span class="metric-label">Autopilot runs (7d)</span><span class="metric-value">' + (share.autopilotRuns || 0) + '</span></div>' +
				'</div>' : '';

			const updatedHtml = usage?.lastUpdated
				? '<div style="font-size:0.65rem;color:var(--muted);margin-top:6px">Updated ' + timeAgo(usage.lastUpdated) + '</div>'
				: '';

			el.innerHTML = '<div class="card">' +
				'<div class="card-header">Resource Usage</div>' +
				utilHtml +
				breakdownHtml +
				sparkHtml +
				budgetHtml +
				runsHtml +
				updatedHtml +
				'</div>';
		}

		// Fetch all data in parallel and render
		Promise.all([
			fetchJSON('autonomy-report.json'),
			fetchJSON('health-report.json'),
			fetchJSON('ai-quality.json'),
			fetchJSON('quality-history.json'),
			fetchJSON('coverage-gaps.json'),
			fetchJSON('autopilot-log.json'),
			fetchJSON('meta.json'),
			fetchJSON('sanity-report.json'),
			fetchJSON('usage-tracking.json'),
			fetchJSON('autonomy-trend.json'),
			fetchJSON('pipeline-result.json')
		]).then(([autonomy, health, quality, history, gaps, autopilotLog, meta, sanity, usage, autonomyTrend, pipelineResult]) => {
			renderOpsOverview(pipelineResult, meta, autopilotLog, health);
			renderSummary(health);
			renderAutonomy(autonomy, autonomyTrend);
			renderAutopilot(autopilotLog);
			renderPipeline(health);
			renderQuality(quality);
			renderTrend(history);
			renderSanity(sanity);
			renderGaps(gaps);
			renderQuota(usage, quality, history);
			renderFreshness(meta);
		});
	</script>
</body>
</html>
